version: "3"

tasks:
  sh-check:
    # NOTE: shellcheck does not have the ability to fix errors.
    aliases:
      - "sh-fix"
    desc: "Runs the shell script linters. Only checks for warnings and violations."
    sources:
      - "{{.G_LINT_VENV_CHECKSUM_FILE}}"
      - "{{.G_SCRIPT_DIR}}/**/*.sh"
      - "{{.TASKFILE}}"
      - exclude: "{{.ROOT_DIR}}/**/.shellcheckrc"
    deps:
      - "venv"
    cmds:
      - task: "shellcheck"
        platforms:
          - "linux"
        vars:
          FLAGS: "--enable=all --severity=style --external-sources --norc"
          SRC_PATHS:
            ref: ".G_LINT_SH_DIRS"
          OS: "linux"
          VENV_DIR: "{{.G_LINT_VENV_DIR}}"

  shellcheck:
    internal: true
    requires:
      vars: ["FLAGS", "SRC_PATHS", "OS", "VENV_DIR"]
    deps:
      - "venv"
    cmd: |-
      . "{{.VENV_DIR}}/bin/activate"
      { \
        # All shell scripts excluding the OS-specific ones
        find {{- range .SRC_PATHS}} "{{.}}" {{- end}} \
          \( -path '**/linux' -o -path '**/macos' \) -prune -o \
          -type f -iname "*.sh" -print0; \
        # All shell scripts exclusive to the specified OS
        find {{- range .SRC_PATHS}} "{{.}}" {{- end}} \
          -type d -name "{{.OS}}" \
            -exec find {} -type f -iname "*.sh" -print0 \; ; \
      } | \
          xargs -0 echo #shellcheck {{.FLAGS}}
