version: "3"

tasks:
  cmake-check:
    desc: "Runs the CMake linters."
    deps:
      - "venv"
    cmds:
      - task: "cmake"
        vars:
          FLAGS: "--diff --color"

  cmake-fix:
    desc: "Runs the CMake linters and fixes all violations."
    deps:
      - "venv"
    cmds:
      - task: "cmake"
        vars:
          FLAGS: "--in-place"

  # Lint all CMake files, excluding those located in build directories.
  #
  # @param {string} FLAGS Options passed into the CMake linter gersemi.
  cmake:
    internal: true
    requires:
      vars:
        - "FLAGS"
    dir: "{{.ROOT_DIR}}"
    cmds:
      - |-
        . "{{.G_LINT_VENV_DIR}}/bin/activate"
        find . \
          -path ./build -prune -o \( \
          -name "CMakeLists.txt" -o \
          -name "*.cmake" -o \
          -name "*.cmake.in" \
        \) -print0 | \
          xargs -0 --no-run-if-empty gersemi {{.FLAGS}}
