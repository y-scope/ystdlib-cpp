version: "3"

tasks:
  validate-all-args:
    internal: true
    requires:
      vars: ["BUILD_TYPE", "TARGET"]
    cmds:
      - task: "validate-build-type"
        vars:
          BUILD_TYPE: "{{.BUILD_TYPE}}"
      - task: "validate-target"
        vars:
          TARGET: "{{.TARGET}}"

  validate-arg:
    internal: true
    requires:
      vars: ["ARG", "VALID_ARGS"]
    preconditions:
      - sh: >-
          {{has .ARG .VALID_ARGS}}
        msg: |-
          {{- if not (has .ARG .VALID_ARGS)}}
            {{.ERR_MSG}}
            "{{.ARG}} is not a valid argument. List of valid arguments:"
            {{- range .VALID_ARGS}}
              {{.}}
            {{- end}}
          {{- end}}

  validate-build-type:
    internal: true
    requires:
      vars: ["BUILD_TYPE"]
    cmds:
      - task: "validate-arg"
        vars:
          ARG: "{{.BUILD_TYPE}}"
          VALID_ARGS:
            ref: ".G_VALID_BUILD_TYPES"

  validate-target:
    internal: true
    requires:
      vars: ["TARGET"]
    cmds:
      - task: "validate-arg"
        vars:
          ARG: "{{.TARGET}}"
          VALID_ARGS:
            ref: ".G_VALID_TARGETS"
