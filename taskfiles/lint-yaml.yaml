version: "3"

tasks:
  yaml:
    aliases:
      - "yaml-check"
      - "yaml-fix"
    desc: "Runs the YAML linters. Only checks for warnings and violations."
    sources:
      - "{{.G_LINT_VENV_CHECKSUM_FILE}}"
      - "{{.ROOT_DIR}}/**/*.yaml"
      - "{{.ROOT_DIR}}/**/*.yml"
      - "{{.TASKFILE}}"
      - exclude: "{{.ROOT_DIR}}/**/build/*"
      - exclude: "{{.ROOT_DIR}}/**/tools/*"
      # The following are for Clion's default generated build dirs
      - exclude: "{{.ROOT_DIR}}/cmake-build-debug/*"
      - exclude: "{{.ROOT_DIR}}/cmake-build-release/*"
    dir: "{{.ROOT_DIR}}"
    deps:
      - "venv"
    cmds:
      - |-
        . "{{.G_LINT_VENV_DIR}}/bin/activate"
        find . \
          \( \
            -path '**/build' \
            -o -path '**/tools' \
            -o -path '**/cmake-build-debug' \
            -o -path '**/cmake-build-release' \
          \) -prune -o \
          \( -iname "*.yaml" -o -iname "*.yml" \) \
          -print0 | \
        xargs -0 yamllint \
          --config-file "tools/yscope-dev-utils/exports/lint-configs/.yamllint.yml" \
          --strict
