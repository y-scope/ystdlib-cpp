version: "3"

includes:
  deps:
    internal: true
    taskfile: "deps.yaml"
  utils:
    internal: true
    taskfile: "../tools/yscope-dev-utils/exports/taskfiles/utils/utils.yaml"

tasks:
  build-debug:
    # The parameter name ystdlib_LIBRARIES should match the CMakeLists.txt equivalent for consistency.
    desc: >-
      build-debug [ystdlib_LIBRARIES="<lib0;...;libn>"]: Configure and build debug libraries. If
      ystdlib_LIBRARIES is defined, only configure and build the listed libraries and their internal
      dependencies.
    cmds:
      - task: "build"
        vars:
          BUILD_TYPE: "debug"
          LIBRARIES: "{{.ystdlib_LIBRARIES}}"

  build-release:
    # The parameter name ystdlib_LIBRARIES should match the CMakeLists.txt equivalent for consistency.
    desc: >-
      build-release [ystdlib_LIBRARIES="<lib0;...;libn>"]: Configure and build release libraries. If
      ystdlib_LIBRARIES is defined, only configure and build the listed libraries and their internal
      dependencies.
    cmds:
      - task: "build"
        vars:
          BUILD_TYPE: "release"
          LIBRARIES: "{{.ystdlib_LIBRARIES}}"

  clean-debug:
    cmds:
      - task: "clean"
        vars:
          BUILD_TYPE: "debug"

  clean-release:
    cmds:
      - task: "clean"
        vars:
          BUILD_TYPE: "release"

  install-debug:
    desc: >-
      install-debug INSTALL_PREFIX="<prefix path>": Install the debug build into <prefix path>.
    requires:
      vars: ["INSTALL_PREFIX"]
    cmds:
      - task: "install"
        vars:
          BUILD_TYPE: "debug"
          INSTALL_PREFIX: "{{.INSTALL_PREFIX}}"

  install-release:
    desc: >-
      install-release INSTALL_PREFIX="<prefix path>": Install the release build into <prefix path>.
    requires:
      vars: ["INSTALL_PREFIX"]
    cmds:
      - task: "install"
        vars:
          BUILD_TYPE: "release"
          INSTALL_PREFIX: "{{.INSTALL_PREFIX}}"

  build:
    internal: true
    requires:
      vars: ["BUILD_TYPE"]
    deps:
      - task: "generate"
        vars:
          BUILD_TYPE: "{{.BUILD_TYPE}}"
          LIBRARIES: "{{.LIBRARIES}}"
    cmds:
      - task: "utils:cmake:build"
        vars:
          BUILD_DIR: "{{.G_YSTDLIB_BUILD_DIR}}/{{.BUILD_TYPE}}"

  clean:
    internal: true
    requires:
      vars: ["BUILD_TYPE"]
    cmds:
      - task: "utils:cmake:clean"
        vars:
          BUILD_DIR: "{{.G_YSTDLIB_BUILD_DIR}}/{{.BUILD_TYPE}}"

  generate:
    internal: true
    requires:
      vars: ["BUILD_TYPE"]
    deps:
      - "deps:all"
    cmds:
      - task: "utils:cmake:generate"
        vars:
          BUILD_DIR: "{{.G_YSTDLIB_BUILD_DIR}}/{{.BUILD_TYPE}}"
          EXTRA_ARGS:
            - "-DCMAKE_BUILD_TYPE={{.BUILD_TYPE}}"
            - |-
              {{- if .LIBRARIES}}
                -D{{.G_CMAKE_PACKAGE_NAME}}_LIBRARIES="{{.LIBRARIES}}"
              {{- end}}
          SOURCE_DIR: "{{.ROOT_DIR}}"

  install:
    internal: true
    vars:
      ABSOLUTE_INSTALL_PREFIX: >-
        {{- if osIsAbs .INSTALL_PREFIX -}}
          {{.INSTALL_PREFIX}}
        {{- else -}}
          {{.USER_WORKING_DIR}}/{{.INSTALL_PREFIX}}
        {{- end}}
    requires:
      vars: ["BUILD_TYPE", "INSTALL_PREFIX"]
    deps:
      - task: "build"
        vars:
          BUILD_TYPE: "{{.BUILD_TYPE}}"
    cmds:
      - task: "utils:cmake:install"
        vars:
          BUILD_DIR: "{{.G_YSTDLIB_BUILD_DIR}}/{{.BUILD_TYPE}}"
          INSTALL_PREFIX: "{{.ABSOLUTE_INSTALL_PREFIX}}"
